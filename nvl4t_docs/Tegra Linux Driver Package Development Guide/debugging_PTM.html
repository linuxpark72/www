<!DOCTYPE html ><html xml:lang="en" lang="en" data-highlight-require-whitespace="false" xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><meta http-equiv="Content-Style-Type" content="text/css" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="IE=edge" /><title>Program Trace Macrocell</title><link rel="Prev" href="debugging_rtrace.html" title="Previous" /><link rel="Next" href="debugging_kgdb.html" title="Next" /><link rel="StyleSheet" href="css/debugging_PTM.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/skin.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/social.css" type="text/css" media="all" /><link rel="StyleSheet" href="css/webworks.css" type="text/css" media="all" /><!--[if IE 7]><link rel="StyleSheet" href="css/debugging_PTM_IE7.css" type="text/css" media="all" /><![endif]--><link rel="StyleSheet" href="css/print.css" type="text/css" media="print" /><script type="text/javascript">
    'use strict';

    var redirect_url, page_hash;

    if ((window === window.top) && (window.navigator.userAgent.indexOf('bot/') === -1)) {
        // Redirect
        //
        redirect_url = "../index.html#page/Tegra%20Linux%20Driver%20Package%20Development%20Guide/debugging_PTM.html";
        if (window.document.location.hash.length > 1) {
            // Sanitize and append it
            //
            page_hash = window.document.location.hash.substring(1);
            page_hash = page_hash.replace(/[\\><:;"]|%5C|%3C|%3E|%3A|%3B|%22/gi, '');
            redirect_url += '#' + page_hash;
        }
        window.document.location.replace(redirect_url);
    }
</script><script type="text/javascript" src="scripts/common.js"></script><script type="text/javascript" src="scripts/page.js"></script><script type="text/javascript" src="scripts/search-client.js"></script><script type="text/javascript" src="scripts/unidata.js"></script><script type="text/javascript" src="scripts/unibreak.js"></script></head><body id="poEYi_002fPq_002bxibSTPlQ8q3_002b3Q" class="ww_skin_page_body" style="background-attachment: scroll; background-image: url(&quot;watermark.png&quot;); background-position: center center; background-repeat: no-repeat; margin-left: 0pt; margin-right: 10pt" onload="Page.OnLoad('../index.html#page/Tegra%20Linux%20Driver%20Package%20Development%20Guide/debugging_PTM.html');"><header id="wwconnect_header"><div><table width="100%" align="center" summary=""><tr><td class="Header_Left"><img alt="NVIDIA Tegra" src="images/NVLogo_2D_H.jpg" width="204" height="44" border="0" /></td><td class="Header_Right"><div>NVIDIA Tegra Linux Driver Package</div><br />
           Development Guide <br /><font size="-1"><div>28.2 Release</div></font><br /></td></tr></table></div><!--     <br clear="all" />
 --><hr color="#DEE4F0" /><div class="ww_skin_page_toolbar"><a class="ww_behavior_print ww_skin ww_skin_print" title="Print" href="#">&nbsp;</a></div></header><div id="wwpID0E0RD0HA" class="Heading_2_Top">Program Trace Macrocell</div><div class="WebWorks_MiniTOC"><div class="WebWorks_MiniTOC_Heading">&nbsp;</div><dl class="WebWorks_MiniTOC_List"><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/debugging_PTM.html#wwpID0E0NC0HA">Using the PTM</a></div></dd><dd><div class="WebWorks_MiniTOC_Entry"><a class="WebWorks_MiniTOC_Link" href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/debugging_PTM.html#wwpID0EYHA">Decode Trace Example</a></div></dd></dl></div><div id="wwpID0E0QD0HA" class="Body_Text">A Program Trace Macrocell (PTM) is a real-time trace module providing instruction tracing of an ARM core. It traces way-points in:</div><div id="wwpID0E0PD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>All indirect branches conditional</div><div id="wwpID0E0OD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Unconditional direct branches</div><div id="wwpID0E0ND0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>All exceptions</div><div id="wwpID0E0MD0HA" class="Body_Text">PTM also generates processing elements. This way the PTM module is triggered when there is a deviation from the normal code flow. The ETM v4 in NVIDIA<span style="vertical-align: super">®</span> Tegra<span style="vertical-align: super">®</span> X1 and X2 devices, and protocols use waypoints and correlate the trace to the code image, vmlinux. These PTM packets can be decoded later using mem_parser to obtain the complete CPU instruction flow.</div><div id="wwpID0E0LD0HA" class="Body_Text">PTM is advantageous may be necessary for:</div><div id="wwpID0E0KD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Debugging - On many production systems it is not possible to connect JTAG devices. In these cases you can use PTM to check which instructions ran before the CPU crashed.</div><div id="wwpID0E0JD0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Code Profiling - Because there is no Watchdog Timer (WDT) reset, code profiling checks are possible, provided a start and end address.</div><div id="wwpID0E0ID0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Performance Analysis - PTM has no performance overhead as compared with <span class="Hyperlink"><a href="../Tegra%20Linux%20Driver%20Package%20Development%20Guide/glossary.html#wwconnect_header" title="Glossary">Ftrace</a></span>. PTM can also provide instruction counts and timestamps that can be used for performance analysis.</div><div id="wwpID0E0HD0HA" class="Body_Text">PTM is a component of the ARM coresight framework. Detailed information about the framework is available at:</div><div id="wwpID0E0GD0HA" class="Code">https://www.kernel.org/doc/Documentation/trace/coresight.txt</div><div id="wwpID0E0FD0HA" class="Heading_5">To configure PTM drivers</div><div id="wwpID0E0ED0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>1.	</span></span>Verify that the coresight drivers have been enabled in the kernel as follows:</div><div id="wwpID0E0DD0HA" class="Code"># zcat /proc/config.gz | grep -i coresight | grep "=y"</div><div id="wwpID0E0CD0HA" class="Code">CONFIG_CORESIGHT=y</div><div id="wwpID0E0BD0HA" class="Code">CONFIG_CORESIGHT_LINKS_AND_SINKS=y</div><div id="wwpID0E0AD0HA" class="Code">CONFIG_CORESIGHT_LINK_AND_SINK_TMC=y</div><div id="wwpID0E06C0HA" class="Code">CONFIG_CORESIGHT_SINK_TPIU=y</div><div id="wwpID0E05C0HA" class="Code">CONFIG_CORESIGHT_SINK_ETBV10=y</div><div id="wwpID0E04C0HA" class="Code">CONFIG_CORESIGHT_SOURCE_ETM4X=y</div><div id="wwpID0E03C0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>2.	</span></span>Verify that the devices defined in the DTB exist in:</div><div id="wwpID0E02C0HA" class="Code">/sys/bus/coresight/devices/.</div><div id="wwpID0E01C0HA" class="List_Number"><span class="WebWorks_Number" style="width: 18pt"><span>3.	</span></span>Execute the commands:</div><div id="wwpID0E0ZC0HA" class="Code"># ll /sys/bus/coresight/devices/ | cut -d " " -f10,11,12</div><div id="wwpID0E0YC0HA" class="Code">8010000.funnel_major -&gt; ../../../devices/8010000.funnel_major/8010000.funnel_major/</div><div id="wwpID0E0XC0HA" class="Code">8030000.etf -&gt; ../../../devices/8030000.etf/8030000.etf/</div><div id="wwpID0E0WC0HA" class="Code">8040000.replicator -&gt; ../../../devices/8040000.replicator/8040000.replicator/</div><div id="wwpID0E0VC0HA" class="Code">8050000.etr -&gt; ../../../devices/8050000.etr/8050000.etr/</div><div id="wwpID0E0UC0HA" class="Code">8060000.tpiu -&gt; ../../../devices/8060000.tpiu/8060000.tpiu/</div><div id="wwpID0E0TC0HA" class="Code">8820000.funnel_minor -&gt; ../../../devices/8820000.funnel_minor/8820000.funnel_minor/</div><div id="wwpID0E0SC0HA" class="Code">9010000.funnel_bccplex -&gt; ../../../devices/9010000.funnel_bccplex/9010000.funnel_bccplex/</div><div id="wwpID0E0RC0HA" class="Code">9840000.ptm -&gt; ../../../devices/9840000.ptm/9840000.ptm/</div><div id="wwpID0E0QC0HA" class="Code">9940000.ptm -&gt; ../../../devices/9940000.ptm/9940000.ptm/</div><div id="wwpID0E0PC0HA" class="Code">9a40000.ptm -&gt; ../../../devices/9a40000.ptm/9a40000.ptm/</div><div id="wwpID0E0OC0HA" class="Code">9b40000.ptm -&gt; ../../../devices/9b40000.ptm/9b40000.ptm/</div><div id="wwpID0E0NC0HA" class="Heading_3">Using the PTM</div><div id="wwpID0E0MC0HA" class="Body_Text">You can enable and disable trace capture at runtime. The content of the ETF/ETR on Tegra X1 or Tegra X2 devices, during the period that trace capture is enabled, can be read back to parse.</div><div class="ww_skin_page_overflow"><table class="Table_Normal" style="margin-left: 36pt" cellspacing="0" summary=""><tr><td style="background-color: #76B900; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 49.5pt"><div id="wwpID0EABA0LC0HA" class="Note_Image">Note:</div></td><td style="background-color: #DDEEBF; background-position: right center; border-bottom-color: Silver; border-bottom-style: solid; border-bottom-width: thin; border-left-color: Silver; border-left-style: solid; border-left-width: thin; border-right-color: Silver; border-right-style: solid; border-right-width: thin; border-top-color: Silver; border-top-style: solid; border-top-width: thin; padding-bottom: 3pt; padding-left: 3pt; padding-right: 3pt; padding-top: 3pt; vertical-align: top; width: 342pt"><div id="wwpID0EAAA0LC0HA" class="Note_Text">PTM is not supported for Denver cores.</div></td></tr></table></div><div id="wwpID0E0KC0HA" class="Heading_5">To collect PTM trace on A57 Core 0</div><div id="wwpID0E0JC0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>On the target, execute the command:</div><div id="wwpID0E0IC0HA" class="Code"># echo 1 &gt; /sys/bus/coresight/devices/8030000.etf/enable_sink</div><div id="wwpID0E0HC0HA" class="Code"># echo 1 &gt; /sys/bus/coresight/devices/9840000.ptm/enable_source </div><div id="wwpID0E0GC0HA" class="Code">[  246.479271] coresight-tmc 8030000.etf: TMC enabled</div><div id="wwpID0E0FC0HA" class="Code">[  246.484362] coresight-funnel 8010000.funnel_major: FUNNEL inport 0 enabled</div><div id="wwpID0E0EC0HA" class="Code">[  246.491890] coresight-funnel 9010000.funnel_bccplex: FUNNEL inport 1 enabled</div><div id="wwpID0E0DC0HA" class="Code">[  246.499761] coresight-etm4x 9840000.ptm: ETM tracing enabled</div><div id="wwpID0E0CC0HA" class="Code"># cat /sys/bus/coresight/devices/8030000.etf/status </div><div id="wwpID0E0BC0HA" class="Code">Depth:          0x2000</div><div id="wwpID0E0AC0HA" class="Code">Status:         0x1</div><div id="wwpID0E06B0HA" class="Code">RAM read ptr:   0x5b60</div><div id="wwpID0E05B0HA" class="Code">RAM wrt ptr:    0x5b60</div><div id="wwpID0E04B0HA" class="Code">Trigger cnt:    0x0</div><div id="wwpID0E03B0HA" class="Code">Control:        0x1</div><div id="wwpID0E02B0HA" class="Code">Flush status:   0x0</div><div id="wwpID0E01B0HA" class="Code">Flush ctrl:     0x133</div><div id="wwpID0E0ZB0HA" class="Code">Mode:           0x0</div><div id="wwpID0E0YB0HA" class="Code">PSRC:           0x0</div><div id="wwpID0E0XB0HA" class="Code">DEVID:          0x580</div><div id="wwpID0E0WB0HA" class="Code"># echo 0 &gt; /sys/bus/coresight/devices//9840000.ptm/enable_source</div><div id="wwpID0E0VB0HA" class="Code">[  264.323280] coresight-etm4x 9840000.ptm: ETM tracing disabled</div><div id="wwpID0E0UB0HA" class="Code">[  264.329400] coresight-funnel 9010000.funnel_bccplex: FUNNEL inport 1 disabled</div><div id="wwpID0E0TB0HA" class="Code">[  264.336998] coresight-funnel 8010000.funnel_major: FUNNEL inport 0 disabled</div><div id="wwpID0E0SB0HA" class="Code">[  264.360311] coresight-tmc 8030000.etf: TMC disabled</div><div id="wwpID0E0RB0HA" class="Code"># dd if=/dev/8030000.etf of=~/cstrace-t186.bin         </div><div id="wwpID0E0QB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>On the host, execute the command:</div><div id="wwpID0E0PB0HA" class="Code">$ ./mem_parser --formatter --etb &lt;dumped_file_with_trace buffer&gt; --elf &lt;vmlinux_with_path&gt; &gt; &lt;output_file_with_instructions&gt;</div><div id="wwpID0E0OB0HA" class="Body_Text_Indent">For example:</div><div id="wwpID0E0NB0HA" class="Code">$ ./mem_parser --formatter --etb ~/cstrace-t186.bin --elf $TEGRA_TOP/out/l4t-t186ref-debug-aarch64/nvidia/kernel/vmlinux &gt; ./cstrace-t186.disassemble.txt</div><div id="wwpID0E0MB0HA" class="Heading_5">To collect PTM trace on other three A57 cores:</div><div id="wwpID0E0LB0HA" class="Body_Text">The correspond commands for other 3 cores in A57 are as follows.</div><div id="wwpID0E0KB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Core 1 on A57:</div><div id="wwpID0E0JB0HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/8030000.etf/enable_sink</div><div id="wwpID0E0IB0HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/9940000.ptm/mode [set EXC bit i.e. bit 24 in ETMTECR1 to trace all memory. Refer *etm*architecture*.pdf, ignore this if you don't know the result.]</div><div id="wwpID0E0HB0HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/9940000.ptm/enable_source (enable tracing)</div><div id="wwpID0E0GB0HA" class="Code">cat /sys/bus/coresight/devices/8030000.etf/status [Will show RAM wrt ptr moving]</div><div id="wwpID0E0FB0HA" class="Code">echo 0 &gt; /sys/bus/coresight/devices//9940000.ptm/enable_source (disable tracing)</div><div id="wwpID0E0EB0HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Core 2 on A57:</div><div id="wwpID0E0DB0HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/8030000.etf/enable_sink</div><div id="wwpID0E0CB0HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/9a40000.ptm/mode [set EXC bit i.e. bit 24 in ETMTECR1 to trace all memory. Refer *etm*architecture*.pdf, ignore this if you don't know the result.]</div><div id="wwpID0E0BB0HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/9a40000.ptm/enable_source (enable tracing)</div><div id="wwpID0E0AB0HA" class="Code">cat /sys/bus/coresight/devices/8030000.etf/status [Will show RAM wrt ptr moving]</div><div id="wwpID0E6HA" class="Code">echo 0 &gt; /sys/bus/coresight/devices//9a40000.ptm/enable_source (disable tracing)</div><div id="wwpID0E5HA" class="List_Bullet"><span class="WebWorks_Number" style="width: 18pt"><span>•	</span></span>Core 3 on A57:</div><div id="wwpID0E4HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/8030000.etf/enable_sink</div><div id="wwpID0E3HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/9b40000.ptm/mode [set EXC bit i.e. bit 24 in ETMTECR1 to trace all memory. Refer *etm*architecture*.pdf, ignore this if you don't know the result.]</div><div id="wwpID0E2HA" class="Code">echo 1 &gt; /sys/bus/coresight/devices/9b40000.ptm/enable_source (enable tracing)</div><div id="wwpID0E1HA" class="Code">cat /sys/bus/coresight/devices/8030000.etf/status [Will show RAM wrt ptr moving]</div><div id="wwpID0EZHA" class="Code">echo 0 &gt; /sys/bus/coresight/devices//9b40000.ptm/enable_source (disable tracing)</div><div id="wwpID0EYHA" class="Heading_3">Decode Trace Example</div><div id="wwpID0EXHA" class="Body_Text">The following example is for <span class="Code_Char">mem_parser</span> Version 2.0.9</div><div id="wwpID0EWHA" class="Code">Parsing Pogram Trace Macrocell buffer (ETM4.x) ......</div><div id="wwpID0EVHA" class="Code">etb buffer size: 32768</div><div id="wwpID0EUHA" class="Code">&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; CPU: ID = 0x20 start:</div><div id="wwpID0ETHA" class="Code">etb buffer size: 30404</div><div id="wwpID0ESHA" class="Code">..........</div><div id="wwpID0ERHA" class="Code">..........</div><div id="wwpID0EQHA" class="Code">ATOM packet format 2:</div><div id="wwpID0EPHA" class="Code">         ATOMS: N, E,</div><div id="wwpID0EOHA" class="Code">&lt;0fc7:da &gt;</div><div id="wwpID0ENHA" class="Code">&lt;__do_softirq+0x130&gt;</div><div id="wwpID0EMHA" class="Code">  ffffffc0000a8b98:      910022b5</div><div id="wwpID0ELHA" class="Code">  ffffffc0000a8b9c:      1ad326d6</div><div id="wwpID0EKHA" class="Code">  ffffffc0000a8ba0:      5ac002d3</div><div id="wwpID0EJHA" class="Code">  ffffffc0000a8ba4:      6b1f02df</div><div id="wwpID0EIHA" class="Code">  ffffffc0000a8ba8:      5ac01273</div><div id="wwpID0EHHA" class="Code">  ffffffc0000a8bac:      1a9307f3</div><div id="wwpID0EGHA" class="Code">E ffffffc0000a8bb0:      35fffb73        cbnz    x19, ffffffc0000a8b1c &lt;__do_softirq+0xb4&gt;</div><div id="wwpID0EFHA" class="Code">&lt;__do_softirq+0xb4&gt;</div><div id="wwpID0EEHA" class="Code">  ffffffc0000a8b1c:      928000e0</div><div id="wwpID0EDHA" class="Code">  ffffffc0000a8b20:      8b33cc00</div><div id="wwpID0ECHA" class="Code">  ffffffc0000a8b24:      8b0002b5</div><div id="wwpID0EBHA" class="Code">  ffffffc0000a8b28:      91080357&lt;__do_softirq+0xb4&gt;</div><footer><!-- Related Topics --><!--                --><!-- Disqus --><!--        --><!-- Google Translation --><!--                    --><br /><hr color="#DEE4F0" /><table width="90%" align="center" summary=""><tr><td class="Footer_Left"><font color="gray"><b></b><br />
           Subject to Change | © 2017 by NVIDIA Corporation.
           All rights reserved.
        </font></td><td class="Footer_Right"><font color="gray"><div>PR-06076-R28</div><br /><div style="text-align: center; font-weight: bold;"><div>Revised: 05 Mar 2018 16:32:33</div></div></font></td></tr></table></footer></body></html>